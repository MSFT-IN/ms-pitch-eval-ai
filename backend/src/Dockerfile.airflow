FROM apache/airflow:2.5.1-python3.10

# ğŸ” ë£¨íŠ¸ ê¶Œí•œìœ¼ë¡œ OS íŒ¨í‚¤ì§€ ì„¤ì¹˜
USER root

RUN apt-get update && apt-get install -y \
    build-essential \
    ffmpeg \
    cmake \
    ninja-build \
    && apt-get clean

# í•„ìš”í•œ ë””ë ‰í† ë¦¬ ë¯¸ë¦¬ ìƒì„±
RUN mkdir -p /home/airflow/.cache/torch/hub/checkpoints \
    && mkdir -p /home/airflow/.cache/voicefixer/analysis_module/checkpoints

# requirements ë¨¼ì € ë³µì‚¬ ë° ì„¤ì¹˜ (airflow ìœ ì €ë¡œ ì„¤ì¹˜í•´ì•¼ í•¨)
COPY requirements.txt /requirements.txt

# ğŸ” airflow ìœ ì €ë¡œ ë³€ê²½
USER airflow

# âœ… requirements ì„¤ì¹˜ (airflow ìœ ì € ê¶Œí•œ)
RUN pip install --user --no-cache-dir -r /requirements.txt

# ğŸ” ë£¨íŠ¸ë¡œ ëŒì•„ê°€ì„œ ëª¨ë¸ íŒŒì¼ ë³µì‚¬ (airflow í™ˆ ë””ë ‰í† ë¦¬ ì ‘ê·¼ ìœ„í•´)
USER root

COPY pretrained_models/demucs/955717e8-8726e21a.th /home/airflow/.cache/torch/hub/checkpoints/
COPY pretrained_models/vocalfixer/analysis_module/checkpoints/vf.ckpt /home/airflow/.cache/voicefixer/analysis_module/checkpoints/vf.ckpt
# VoiceFixer - synthesis module
COPY pretrained_models/vocalfixer/synthesis_module/44100/model.ckpt-1490000_trimed.pt /home/airflow/.cache/voicefixer/synthesis_module/44100/model.ckpt-1490000_trimed.pt
# airflow ìœ ì €ë¡œ ë‹¤ì‹œ ì „í™˜
USER airflow
